<!DOCTYPE html>
<html>
<head>
  <title>Stereo 3D image viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="icon" type="image/svg+xml" href="icons/icon.svg">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:creator" content="@steren">
  <meta name="twitter:title" content="Stereo 3D image viewer">
  <meta name="twitter:image" content="https://stereo-viewer.app/title.png">

  <meta property="og:type" content="article">
  <meta property="og:title" content="Stereo 3D image viewer">
  <meta property="og:image" content="https://stereo-viewer.app/title.png">

  <meta name="color-scheme" content="dark">
  <meta name="theme-color" content="#00ff8f">

  <script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "WebSite",
    "author": "Steren Giannini",
    "name": "Stereo 3D image viewer",
    "image": "https://stereo-viewer.app/title.png"
  }
  </script>

  <!-- Polyfill for WebXR -->
  <script src="https://cdn.jsdelivr.net/npm/webxr-polyfill@latest/build/webxr-polyfill.js"></script>
  <script>
    window.polyfill = new WebXRPolyfill();
  </script>

  <script type="module" src="https://stereo-img.steren.fr/stereo-img.js"></script>

  <style>
    html {
      margin: auto;
      line-height: 1.75;
      font-size: 1.25em;
      font-family: sans-serif;
      background-color: #000;
      color: #fff;
    }

    body {
      margin: 0;
    }

    stereo-img {
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      bottom: 0;
      z-index: -1;
    }

    #ui {
      visibility: hidden;
    }

    #zero-state {
      display: flex;
	    align-items: center;
	    justify-content: center;
      flex-direction: column;
      height: 100vh;
    }

  </style>

  <link rel="manifest" href="manifest.json">
</head>

<body id="dropbox">
  <stereo-img></stereo-img>

  <div id="zero-state">
    <p id="hint">Drag and drop or select a stereo picture</p>
    <input id="file-input" type="file" accept="image/*" multiple>  
  </div>

  <!-- TODO: Display UI on top of viewer without blocking viewer interactions-->
  <div id="ui">
    <!-- TODO: Add radio button for type -->
    <button id="previous">Previous</button> <button id="next">Next</button>
  </div>

  <script>
    let allFiles = [];
    let currentIndex = 0;

    function hideZeroState() {
      document.getElementById('zero-state').style.display = 'none';
    }

    function handleFiles(files) {
      console.log("Handling files:", files);
      allFiles = [];
      for (let i = 0; i < files.length; i++) {
        let file = files[i];
        if (file.type.startsWith('image/')){
          allFiles.push(file);
        }
      }

      if (allFiles.length > 0) {
        currentIndex = 0;
        displayFile(allFiles[currentIndex]);
      } else {
        document.querySelector('stereo-img').src = '';
        document.getElementById('zero-state').style.display = 'flex';
      }
      updateButtonStates();
    }

    function displayFile(file) {
      let reader = new FileReader();
      reader.onload = e => { processFile(e.target.result, file.name); };
      reader.readAsDataURL(file);
    }

    function processFile(url, name) {
      console.log("Processing file:", name);
      const stereoImg = document.querySelector('stereo-img');
      stereoImg.src = url;

      hideZeroState();
    }

    function updateButtonStates() {
      if (allFiles.length === 0) {
        document.getElementById('ui').style.visibility = 'hidden';
        document.getElementById('previous').disabled = true;
        document.getElementById('next').disabled = true;
        return;
      }
      document.getElementById('ui').style.visibility = 'visible';
      document.getElementById('previous').disabled = currentIndex === 0;
      document.getElementById('next').disabled = currentIndex === allFiles.length - 1;
    }

    document.getElementById("file-input").addEventListener("change", (e) => {
      handleFiles(e.target.files);
    }, false);

    document.getElementById("previous").addEventListener("click", () => {
      if (currentIndex > 0) {
        currentIndex--;
        displayFile(allFiles[currentIndex]);
        updateButtonStates();
      }
    });

    document.getElementById("next").addEventListener("click", () => {
      if (currentIndex < allFiles.length - 1) {
        currentIndex++;
        displayFile(allFiles[currentIndex]);
        updateButtonStates();
      }
    });

    // Drag and drop
    const dropzone = document.getElementById("dropbox");
    dropzone.ondragover = dropzone.ondragenter = (e) => {
      e.stopPropagation();
      e.preventDefault();
    }
    dropzone.ondrop = (e) => {
      e.stopPropagation();
      e.preventDefault();
      console.log("Files dropped");
      handleFiles(e.dataTransfer.files);
    }

    //File Handling API, see https://web.dev/file-handling/
    if ('launchQueue' in window && 'files' in LaunchParams.prototype) {
      launchQueue.setConsumer(async (launchParams) => {
        // Nothing to do when the queue is empty.
        if (!launchParams.files.length) {
          return;
        }
        console.log("File(s) to Handle (File Handling API)");

        // Resolve FileSystemFileHandle array to File array
        const files = await Promise.all(launchParams.files.map( (fileHandle) => {return fileHandle.getFile();} ));
        handleFiles(files);
      });
    }


    navigator.serviceWorker.register('sw.js')
    navigator.serviceWorker.addEventListener('message', event => {
      if(event.files) {
        handleFiles(event.files);
      }
    });

    updateButtonStates();
  </script>

</body>

</html>